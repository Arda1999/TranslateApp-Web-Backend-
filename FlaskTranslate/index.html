<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/vite.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="/src/css/main.css" />
  <style>
    /* Custom Connection Request Modal */
    #connectionModal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.6);
      animation: fadeIn 0.3s;
    }
    #connectionModalContent {
      position: relative;
      background-color: #fff;
      margin: 15% auto;
      padding: 30px;
      border-radius: 15px;
      width: 90%;
      max-width: 450px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.3);
      animation: slideDown 0.4s;
    }
    #connectionModalContent h3 {
      margin-top: 0;
      color: #2c3e50;
      font-size: 1.5rem;
      margin-bottom: 20px;
    }
    #connectionModalContent p {
      font-size: 1.1rem;
      margin-bottom: 25px;
      color: #555;
    }
    .modal-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
    }
    .modal-buttons button {
      flex: 1;
      padding: 12px 20px;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
    }
    #acceptConnectionBtn {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
    }
    #acceptConnectionBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
    }
    #rejectConnectionBtn {
      background: linear-gradient(135deg, #dc3545, #c82333);
      color: white;
    }
    #rejectConnectionBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideDown {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* Section Styling */
    .section-divider {
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .section-divider:last-child {
      border-bottom: none;
    }

    .section-title {
      color: #495057;
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 1rem;
    }

    /* User List Container */
    .user-list-container {
      max-height: 300px;
      overflow-y: auto;
    }

    .user-list-container::-webkit-scrollbar {
      width: 6px;
    }

    .user-list-container::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    .user-list-container::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 10px;
    }

    .user-list-container::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    /* Status Pill Enhancement */
    .status-pill {
      font-size: 0.85rem;
      padding: 0.35rem 0.75rem;
      border-radius: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 500;
    }

    /* Online Count Badge */
    .badge.bg-success {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      margin-left: 0.5rem;
    }

    /* Form Enhancements */
    .form-label.fw-semibold {
      color: #495057;
      font-size: 0.9rem;
    }

    .input-group-text {
      background-color: #f8f9fa;
      border-right: none;
    }

    .input-group .form-control {
      border-left: none;
    }

    .input-group .form-control:focus {
      border-color: #ced4da;
      box-shadow: none;
    }

    /* Button Enhancement */
    .btn-start {
      font-weight: 600;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .btn-start:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }

    /* Alert Styling */
    .alert-info {
      background-color: #e7f3ff;
      border-color: #b3d9ff;
      color: #004085;
      font-size: 0.85rem;
    }

    /* Form Switch Enhancement */
    .form-check-input:checked {
      background-color: #28a745;
      border-color: #28a745;
    }

    /* Select Enhancement */
    .form-select {
      cursor: pointer;
    }

    .form-select:disabled {
      background-color: #e9ecef;
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .section-title {
        font-size: 0.85rem;
      }
      
      .user-list-container {
        max-height: 200px;
      }
    }
  </style>
</head>
<body>

  <div class="container mt-7">
    <div class="app-surface app-header">
      <div class="app-title">
        <h1>GerÃ§ek ZamanlÄ± KonuÅŸma Ve Ã‡eviri UygulamasÄ±</h1>
        <p>WebSocket (8080) â€¢ Flask services (5000/5001/5002) â€¢ Mic switch (3005)</p>
         <div class="mt-2">
           <span class="status-pill" id="myUserIdPill" style="font-size: 0.95rem; padding: 0.5rem 1rem;">
              <i class="bi bi-person-badge-fill"></i> <span id="displayUsername">Misafir</span>
            </span>
         </div>
      </div>
      <div class="status-pill" id="wsStatus">WS: connectingâ€¦</div>
    </div>

    <div class="layout">
      <!-- ============================================ -->
      <!-- SOL TARAF: BaÄŸlantÄ± YÃ¶netimi -->
      <!-- ============================================ -->
      <div class="app-surface card">
        <div class="card-header">
          <div class="d-flex justify-content-between align-items-center">
            <h3 class="mb-0">
              <i class="bi bi-people-fill me-2"></i>BaÄŸlantÄ± YÃ¶netimi
            </h3>
         
          </div>
        </div>

        <div class="card-body">
          <!-- KullanÄ±cÄ± Profili BÃ¶lÃ¼mÃ¼ -->
          <div class="section-divider mb-4">
            <h6 class="section-title">
              <i class="bi bi-person-circle me-2"></i>KullanÄ±cÄ± Profili
            </h6>
            <div class="mb-3">
              <label for="usernameInput" class="form-label fw-semibold">
                GÃ¶rÃ¼nen AdÄ±nÄ±z <span class="text-danger">*</span>
              </label>
              <input 
                type="text" 
                id="usernameInput" 
                placeholder="AdÄ±nÄ±zÄ± girin (max. 20 karakter)" 
                class="form-control" 
                maxlength="20"
                required 
              />
              <div class="d-grid gap-2 mt-2">
                <button id="updateUsernameBtn" class="btn btn-primary" type="button">
                  <i class="bi bi-check-circle me-1"></i>KullanÄ±cÄ± AdÄ±nÄ± GÃ¼ncelle
                </button>
              </div>
              <small class="form-text text-muted">
                <i class="bi bi-info-circle me-1"></i>Bu isim diÄŸer kullanÄ±cÄ±lar tarafÄ±ndan gÃ¶rÃ¼lecektir
              </small>
            </div>
          </div>

          <!-- Aktif KullanÄ±cÄ±lar BÃ¶lÃ¼mÃ¼ -->
          <div class="section-divider mb-4">
            <h6 class="section-title">
              <i class="bi bi-people me-2"></i>Ã‡evrimiÃ§i KullanÄ±cÄ±lar
              <span class="badge bg-success" id="onlineCount">0</span>
            </h6>
            <div class="user-list-container">
              <ul id="userList" class="list-group mb-3"></ul>
              <small class="form-text text-muted">
                <i class="bi bi-info-circle me-1"></i>BaÄŸlantÄ± kurmak iÃ§in kullanÄ±cÄ±ya tÄ±klayÄ±n
              </small>
            </div>
          </div>

          <!-- BaÄŸlantÄ± Kurma BÃ¶lÃ¼mÃ¼ -->
          <div class="section-divider mb-4">
            <h6 class="section-title">
              <i class="bi bi-link-45deg me-2"></i>Direkt BaÄŸlantÄ±
            </h6>
            <div class="mb-3">
              <label for="targetUserId" class="form-label fw-semibold">
                Hedef KullanÄ±cÄ± ID
              </label>
              <div class="input-group">
             
                <input 
                  type="text" 
                  id="targetUserId" 
                  class="form-control"
                  pattern="[a-zA-Z0-9]+"
                />
              </div>
              <small class="form-text text-muted">
                <i class="bi bi-info-circle me-1"></i>KullanÄ±cÄ± ID'sini manuel olarak girebilirsiniz
              </small>
            </div>

            <div class="d-grid gap-2">
              <button id="connectBtn" class="btn btn-success btn-lg btn-start">
                <i class="bi bi-telephone-fill me-2"></i>BaÄŸlantÄ± Kur
              </button>
              <button id="disconnectBtn" class="btn btn-danger btn-lg" style="display: none;">
                <i class="bi bi-telephone-x-fill me-2"></i>BaÄŸlantÄ±yÄ± Kes
              </button>
            </div>
          </div>

          <!-- Dil AyarlarÄ± BÃ¶lÃ¼mÃ¼ -->
          <div class="section-divider mb-0">
            <h6 class="section-title">
              <i class="bi bi-translate me-2"></i>Dil ve Ã‡eviri AyarlarÄ±
            </h6>
            
            <!-- Otomatik Dil Tespiti -->
            <div class="mb-3">
              <div class="form-check form-switch">
                <input 
                  type="checkbox" 
                  class="form-check-input" 
                  id="autoDetectLanguage" 
                  checked
                  role="switch"
                >
                <label class="form-check-label fw-semibold" for="autoDetectLanguage">
                  <i class="bi bi-magic me-1"></i>Otomatik Dil Tespiti
                </label>
              </div>
              <small class="form-text text-muted d-block ms-4">
                Aktif: KonuÅŸma dilini otomatik tespit eder<br>
                Pasif: AÅŸaÄŸÄ±da seÃ§ilen dili kullanÄ±r
              </small>
            </div>

            <!-- Kaynak Dil SeÃ§imi -->
            <div class="mb-3">
              <label for="languageSelect" class="form-label fw-semibold">
                Kaynak Dil (KonuÅŸacaÄŸÄ±nÄ±z Dil)
              </label>
              <select id="languageSelect" class="form-select" disabled>
                <optgroup label="YaygÄ±n KullanÄ±lan Diller">
                  <option value="tr-TR" selected>ğŸ‡¹ğŸ‡· TÃ¼rkÃ§e (Turkish)</option>
                  <option value="en-US">ğŸ‡ºğŸ‡¸ English</option>
                  <option value="de-DE">ğŸ‡©ğŸ‡ª Deutsch (German)</option>
                  <option value="fr-FR">ğŸ‡«ğŸ‡· FranÃ§ais (French)</option>
                  <option value="es-ES">ğŸ‡ªğŸ‡¸ EspaÃ±ol (Spanish)</option>
                  <option value="it-IT">ğŸ‡®ğŸ‡¹ Italiano (Italian)</option>
                  <option value="pt-PT">ğŸ‡µğŸ‡¹ PortuguÃªs (Portuguese)</option>
                  <option value="ru-RU">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹ (Russian)</option>
                  <option value="ar-SA">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Arabic)</option>
                  <option value="zh-CN">ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡ (Chinese Simplified)</option>
                  <option value="ja-JP">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª (Japanese)</option>
                  <option value="ko-KR">ğŸ‡°ğŸ‡· í•œêµ­ì–´ (Korean)</option>
                </optgroup>

                <optgroup label="Avrupa Dilleri">
                  <option value="nl-NL">ğŸ‡³ğŸ‡± Nederlands (Dutch)</option>
                  <option value="pl-PL">ğŸ‡µğŸ‡± Polski (Polish)</option>
                  <option value="cs-CZ">ğŸ‡¨ğŸ‡¿ ÄŒeÅ¡tina (Czech)</option>
                  <option value="sk-SK">ğŸ‡¸ğŸ‡° SlovenÄina (Slovak)</option>
                  <option value="hu-HU">ğŸ‡­ğŸ‡º Magyar (Hungarian)</option>
                  <option value="ro-RO">ğŸ‡·ğŸ‡´ RomÃ¢nÄƒ (Romanian)</option>
                  <option value="bg-BG">ğŸ‡§ğŸ‡¬ Ğ‘ÑŠĞ»Ğ³Ğ°Ñ€ÑĞºĞ¸ (Bulgarian)</option>
                  <option value="hr-HR">ğŸ‡­ğŸ‡· Hrvatski (Croatian)</option>
                  <option value="sr-RS">ğŸ‡·ğŸ‡¸ Ğ¡Ñ€Ğ¿ÑĞºĞ¸ (Serbian)</option>
                  <option value="sl-SI">ğŸ‡¸ğŸ‡® SlovenÅ¡Äina (Slovenian)</option>
                  <option value="uk-UA">ğŸ‡ºğŸ‡¦ Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ° (Ukrainian)</option>
                  <option value="el-GR">ğŸ‡¬ğŸ‡· Î•Î»Î»Î·Î½Î¹ÎºÎ¬ (Greek)</option>
                  <option value="sv-SE">ğŸ‡¸ğŸ‡ª Svenska (Swedish)</option>
                  <option value="da-DK">ğŸ‡©ğŸ‡° Dansk (Danish)</option>
                  <option value="fi-FI">ğŸ‡«ğŸ‡® Suomi (Finnish)</option>
                  <option value="no-NO">ğŸ‡³ğŸ‡´ Norsk (Norwegian)</option>
                  <option value="is-IS">ğŸ‡®ğŸ‡¸ Ãslenska (Icelandic)</option>
                  <option value="et-EE">ğŸ‡ªğŸ‡ª Eesti (Estonian)</option>
                  <option value="lv-LV">ğŸ‡±ğŸ‡» LatvieÅ¡u (Latvian)</option>
                  <option value="lt-LT">ğŸ‡±ğŸ‡¹ LietuviÅ³ (Lithuanian)</option>
                </optgroup>

                <optgroup label="Asya-Pasifik Dilleri">
                  <option value="zh-TW">ğŸ‡¹ğŸ‡¼ ç¹é«”ä¸­æ–‡ (Chinese Traditional)</option>
                  <option value="zh-HK">ğŸ‡­ğŸ‡° ç²µèª (Cantonese)</option>
                  <option value="hi-IN">ğŸ‡®ğŸ‡³ à¤¹à¤¿à¤¨à¥à¤¦à¥€ (Hindi)</option>
                  <option value="bn-IN">ğŸ‡®ğŸ‡³ à¦¬à¦¾à¦‚à¦²à¦¾ (Bengali)</option>
                  <option value="ta-IN">ğŸ‡®ğŸ‡³ à®¤à®®à®¿à®´à¯ (Tamil)</option>
                  <option value="te-IN">ğŸ‡®ğŸ‡³ à°¤à±†à°²à±à°—à± (Telugu)</option>
                  <option value="mr-IN">ğŸ‡®ğŸ‡³ à¤®à¤°à¤¾à¤ à¥€ (Marathi)</option>
                  <option value="ur-PK">ğŸ‡µğŸ‡° Ø§Ø±Ø¯Ùˆ (Urdu)</option>
                  <option value="th-TH">ğŸ‡¹ğŸ‡­ à¹„à¸—à¸¢ (Thai)</option>
                  <option value="vi-VN">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t (Vietnamese)</option>
                  <option value="id-ID">ğŸ‡®ğŸ‡© Bahasa Indonesia (Indonesian)</option>
                  <option value="ms-MY">ğŸ‡²ğŸ‡¾ Bahasa Melayu (Malay)</option>
                  <option value="tl-PH">ğŸ‡µğŸ‡­ Filipino (Tagalog)</option>
                </optgroup>

                <optgroup label="Orta DoÄŸu ve Afrika Dilleri">
                  <option value="fa-IR">ğŸ‡®ğŸ‡· ÙØ§Ø±Ø³ÛŒ (Persian)</option>
                  <option value="he-IL">ğŸ‡®ğŸ‡± ×¢×‘×¨×™×ª (Hebrew)</option>
                  <option value="sw-KE">ğŸ‡°ğŸ‡ª Kiswahili (Swahili)</option>
                  <option value="am-ET">ğŸ‡ªğŸ‡¹ áŠ áˆ›áˆ­áŠ› (Amharic)</option>
                  <option value="zu-ZA">ğŸ‡¿ğŸ‡¦ isiZulu (Zulu)</option>
                </optgroup>

                <optgroup label="Latin Amerika Dilleri">
                  <option value="es-MX">ğŸ‡²ğŸ‡½ EspaÃ±ol (Mexican Spanish)</option>
                  <option value="es-AR">ğŸ‡¦ğŸ‡· EspaÃ±ol (Argentinian Spanish)</option>
                  <option value="pt-BR">ğŸ‡§ğŸ‡· PortuguÃªs (Brazilian Portuguese)</option>
                </optgroup>

                <optgroup label="DiÄŸer Diller">
                  <option value="ca-ES">ğŸ‡ªğŸ‡¸ CatalÃ  (Catalan)</option>
                  <option value="eu-ES">ğŸ‡ªğŸ‡¸ Euskara (Basque)</option>
                  <option value="gl-ES">ğŸ‡ªğŸ‡¸ Galego (Galician)</option>
                  <option value="af-ZA">ğŸ‡¿ğŸ‡¦ Afrikaans</option>
                  <option value="sq-AL">ğŸ‡¦ğŸ‡± Shqip (Albanian)</option>
                  <option value="hy-AM">ğŸ‡¦ğŸ‡² Õ€Õ¡ÕµÕ¥Ö€Õ¥Õ¶ (Armenian)</option>
                  <option value="az-AZ">ğŸ‡¦ğŸ‡¿ AzÉ™rbaycan (Azerbaijani)</option>
                  <option value="ka-GE">ğŸ‡¬ğŸ‡ª áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜ (Georgian)</option>
                  <option value="kk-KZ">ğŸ‡°ğŸ‡¿ ÒšĞ°Ğ·Ğ°Ò› (Kazakh)</option>
                  <option value="km-KH">ğŸ‡°ğŸ‡­ ááŸ’á˜áŸ‚áš (Khmer)</option>
                  <option value="lo-LA">ğŸ‡±ğŸ‡¦ àº¥àº²àº§ (Lao)</option>
                  <option value="my-MM">ğŸ‡²ğŸ‡² á€™á€¼á€”á€ºá€™á€¬ (Burmese)</option>
                  <option value="ne-NP">ğŸ‡³ğŸ‡µ à¤¨à¥‡à¤ªà¤¾à¤²à¥€ (Nepali)</option>
                  <option value="si-LK">ğŸ‡±ğŸ‡° à·ƒà·’à¶‚à·„à¶½ (Sinhala)</option>
                </optgroup>
              </select>
            </div>
          </div>
        </div>
      </div>
      <!-- ============================================ -->
      <!-- SAÄ TARAF: KonuÅŸma & Ã‡eviri -->
      <!-- ============================================ -->
      <div class="app-surface card">
        <div class="card-header">
          <div class="d-flex justify-content-between align-items-center">
            <h3 class="mb-0">
              <i class="bi bi-mic-fill me-2"></i>KonuÅŸma â€¢ Ã‡eviri â€¢ Ses
            </h3>
            <span class="status-pill" id="modePill">Mode: â€”</span>
          </div>
        </div>
        <div class="card-body">
          <!-- Kontrol ButonlarÄ± -->
          <div class="section-divider mb-4">
            <h6 class="section-title">
              <i class="bi bi-controller me-2"></i>KayÄ±t Kontrolleri
            </h6>
            <div class="btn-wrapper d-flex flex-column flex-md-row justify-content-start" style="gap: 10px;">
              <button id="startBtn" class="btn btn-danger btn-start mb-2 mb-md-0">
                <i class="bi bi-record-circle me-2"></i>
                <span>KayÄ±da BaÅŸla</span>
              </button>
              <button id="startBtn2" class="btn btn-primary btn-start mb-2 mb-md-0">
                <i class="bi bi-broadcast me-2"></i>
                <span>KonuÅŸmaya BaÅŸla</span>
              </button>
              <button id="stopBtn" class="btn btn-secondary btn-stop mb-2 mb-md-0" disabled>
                <i class="bi bi-stop-circle me-2"></i>
                KayÄ±dÄ± Durdur
              </button>
              <button id="clearBtn" class="btn btn-warning btn-clear mb-2 mb-md-0">
                <i class="bi bi-trash me-2"></i>
                MesajlarÄ± Temizle
              </button>
               <button id="clearBtnVoice" class="btn btn-warning btn-clear mb-2 mb-md-0">
                <i class="bi bi-trash me-2"></i>
                Sesli MesajlarÄ± Temizle
              </button>
            </div>
          </div>

          <!-- KonuÅŸma ve Ã‡eviri Metinleri -->
          <div class="section-divider mb-4">
            <h6 class="section-title">
              <i class="bi bi-chat-text me-2"></i>AnlÄ±k Ã‡eviri SonuÃ§larÄ±
            </h6>
            <div class="row g-3">
              <div class="col-12 col-lg-6">
                <div class="card" style="background: transparent; border: 2px solid #e3f2fd;">
                  <div class="card-header bg-primary text-white">
                    <i class="bi bi-mic me-2"></i>
                    <strong>KonuÅŸma Metni</strong>
                  </div>
                  <div class="card-body">
                    <div id="result" class="result border p-3 bg-light" style="min-height: 220px; font-size: 1.1rem;"></div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-lg-6">
                <div class="card" style="background: transparent; border: 2px solid #e8f5e9;">
                  <div class="card-header bg-success text-white">
                    <i class="bi bi-translate me-2"></i>
                    <strong>Ã‡eviri Metni</strong>
                  </div>
                  <div class="card-body">
                    <div id="translatedResult" class="result border p-3 bg-light" style="min-height: 220px; font-size: 1.1rem;"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Gelen Ses MesajlarÄ± -->
          <div class="section-divider mb-4">
            <h6 class="section-title">
              <i class="bi bi-volume-up me-2"></i>KarÅŸÄ± Taraftan Ses MesajlarÄ±
            </h6>
            <div class="card" style="background: transparent; border: 2px solid #fff3e0;">
              <div class="card-header bg-warning">
                <i class="bi bi-headphones me-2"></i>
                <strong>Gelen Sesler</strong>
              </div>
              <div class="card-body">
                <div id="incomingAudioContainer"></div>
              </div>
            </div>
          </div>

          <!-- GeÃ§miÅŸ SonuÃ§lar -->
          <div class="section-divider mb-0">
            <h6 class="section-title">
              <i class="bi bi-clock-history me-2"></i>GeÃ§miÅŸ SonuÃ§lar
            </h6>
            <div class="card" style="background: transparent; border: 2px solid #f3e5f5;">
              <div class="card-header bg-info text-white">
                <i class="bi bi-archive me-2"></i>
                <strong>KayÄ±t GeÃ§miÅŸi</strong>
              </div>
              <div class="card-body">
                <div id="resultsHistory"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- Connection Request Modal -->
<div id="connectionModal">
  <div id="connectionModalContent">
    <h3>ğŸ”” BaÄŸlantÄ± Ä°steÄŸi</h3>
    <p id="connectionRequestText"></p>
    <div class="modal-buttons">
      <button id="acceptConnectionBtn">âœ… Kabul Et</button>
      <button id="rejectConnectionBtn">âŒ Reddet</button>
    </div>
  </div>
</div>

<script>
// Otomatik dil tespiti deÄŸiÅŸtiÄŸinde kaynak dil seÃ§imini aktif/pasif yap
document.getElementById('autoDetectLanguage').addEventListener('change', function() {
  const sourceSelect = document.getElementById('languageSelect');
  sourceSelect.disabled = this.checked;
  updateLanguageFlowSummary();
});

// Dil seÃ§imi deÄŸiÅŸtiÄŸinde Ã¶zet gÃ¼ncelle (eÄŸer Ã¶zellik varsa)
const targetLanguageSelect = document.getElementById('targetLanguageSelect');
const languageFlowSummary = document.getElementById('languageFlowSummary');

if (languageFlowSummary && targetLanguageSelect) {
  document.getElementById('languageSelect').addEventListener('change', updateLanguageFlowSummary);
  targetLanguageSelect.addEventListener('change', updateLanguageFlowSummary);
}

function updateLanguageFlowSummary() {
  const autoDetect = document.getElementById('autoDetectLanguage').checked;
  const sourceSelect = document.getElementById('languageSelect');
  const targetSelect = document.getElementById('targetLanguageSelect');
  const summaryElement = document.getElementById('languageFlowSummary');
  
  if (!summaryElement || !sourceSelect || !targetSelect) return; // Guard clause
  
  const sourceLang = autoDetect ? 'Otomatik tespit' : sourceSelect.options[sourceSelect.selectedIndex].text;
  const targetLang = targetSelect.options[targetSelect.selectedIndex].text;
  
  summaryElement.textContent = `${sourceLang} â†’ ${targetLang}`;
}

// Sayfa yÃ¼klendiÄŸinde Ã¶zeti gÃ¼ncelle (eÄŸer Ã¶zellik varsa)
if (languageFlowSummary && targetLanguageSelect) {
  updateLanguageFlowSummary();
}

// Cihaz tipini tespit et (GeliÅŸtirilmiÅŸ)
function detectDeviceType() {
  const userAgent = navigator.userAgent || navigator.vendor || window.opera;
  const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
  const screenWidth = window.innerWidth || screen.width;
  
  // iOS kontrolÃ¼ (Ã¶ncelikli)
  if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
    return 'ğŸ“± MOBÄ°L (iOS)';
  }
  
  // Android kontrolÃ¼ (Ã¶ncelikli)
  if (/android/i.test(userAgent)) {
    // Android tablet vs telefon ayrÄ±mÄ±
    if (screenWidth >= 768) {
      return 'ğŸ“± TABLET (Android)';
    }
    return 'ğŸ“± MOBÄ°L (Android)';
  }
  
  // Genel mobil kontrolleri
  if (/webOS|BlackBerry|IEMobile|Opera Mini/i.test(userAgent)) {
    return 'ğŸ“± MOBÄ°L';
  }
  
  // Mobile kelimesi iÃ§eriyorsa (geniÅŸ kontrol)
  if (/Mobile/i.test(userAgent)) {
    return 'ğŸ“± MOBÄ°L';
  }
  
  // Tablet kontrolÃ¼
  if (/Tablet|iPad/i.test(userAgent)) {
    return 'ğŸ“± TABLET';
  }
  
  // Touch ekran + kÃ¼Ã§Ã¼k ekran = muhtemelen mobil
  if (isTouchDevice && screenWidth < 768) {
    return 'ğŸ“± MOBÄ°L (Touch Device)';
  }
  
  // Touch ekran + orta ekran = tablet olabilir
  if (isTouchDevice && screenWidth >= 768 && screenWidth < 1024) {
    return 'ğŸ“± TABLET (Touch Device)';
  }
  
  // Desktop
  return 'ğŸ’» BÄ°LGÄ°SAYAR (Desktop)';
}

// Sayfa yÃ¼klendiÄŸinde cihaz tipini gÃ¶ster
const deviceType = detectDeviceType();
console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
console.log(`ğŸŒ BaÄŸlantÄ± Bilgisi: ${deviceType}`);
console.log(`ğŸ“¡ User Agent: ${navigator.userAgent}`);
console.log(`ğŸ“ Ekran Boyutu: ${window.innerWidth}x${window.innerHeight}`);
console.log(`ğŸ‘† Touch Support: ${'ontouchstart' in window}`);
console.log(`ğŸ–±ï¸ Max Touch Points: ${navigator.maxTouchPoints}`);
console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

// WebSocket baÄŸlantÄ±sÄ± - SayfayÄ± hangi adresten aÃ§Ä±yorsan o adresi kullan
const currentHost = window.location.hostname;
const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
const socket = new WebSocket(`${wsProtocol}//${currentHost}:8080`);
console.log(`ğŸ”Œ WebSocket baÄŸlanÄ±yor: ${wsProtocol}//${currentHost}:8080 (Otomatik algÄ±landÄ±)`);

let mediaRecorder;
let audioChunks = [];
let userId = null;
let audioQueue = [];
let isPlayingAudio = false;

async function playNextAudio() {
  if (isPlayingAudio || audioQueue.length === 0) return;
  
  isPlayingAudio = true;
  const audioUrl = audioQueue.shift();
  
  const audio = new Audio(audioUrl);
  audio.play();
  
  audio.onended = () => {
    isPlayingAudio = false;
    playNextAudio(); // SÄ±radaki sesi Ã§al
  };
  
  audio.onerror = () => {
    console.error('Ses Ã§alÄ±namadÄ±, sÄ±radakine geÃ§iliyor');
    isPlayingAudio = false;
    playNextAudio();
  };
}

function setStatusPill(el, text, tone) {
  el.textContent = text;
  el.style.borderColor = tone === 'good' ? 'rgba(22,163,74,0.55)' : tone === 'bad' ? 'rgba(239,68,68,0.55)' : 'rgba(148,163,184,0.45)';
  el.style.background = tone === 'good' ? 'rgba(22,163,74,0.08)' : tone === 'bad' ? 'rgba(239,68,68,0.08)' : 'rgba(2,6,23,0.02)';
  el.style.color = tone === 'good' ? '#166534' : tone === 'bad' ? '#991b1b' : '#475569';
}

socket.onopen = () => {
  console.log('âœ… WebSocket sunucusuna baÄŸlandÄ±');
  const wsStatus = document.getElementById('wsStatus');
  if (wsStatus) setStatusPill(wsStatus, 'WS: connected', 'good');
};

socket.onerror = (error) => {
  console.error('âŒ WebSocket hatasÄ±:', error);
  const wsStatus = document.getElementById('wsStatus');
  if (wsStatus) setStatusPill(wsStatus, 'WS: error', 'bad');
  alert('WebSocket baÄŸlantÄ± hatasÄ±! Sunucu Ã§alÄ±ÅŸÄ±yor mu kontrol edin.');
};

socket.onclose = () => {
  console.log('âš ï¸ WebSocket baÄŸlantÄ±sÄ± kapandÄ±');
  const wsStatus = document.getElementById('wsStatus');
  if (wsStatus) setStatusPill(wsStatus, 'WS: closed', 'bad');
  alert('WebSocket baÄŸlantÄ±sÄ± kesildi! SayfayÄ± yenileyin.');
};

// WebSocket mesajlarÄ±nÄ± alÄ±yoruz
socket.onmessage = (event) => {
  const message = JSON.parse(event.data);

  // KullanÄ±cÄ± ID'si alÄ±ndÄ±ÄŸÄ±nda
  if (message.type === 'user_id') {
    userId = message.userId;
    console.log('Benim kullanÄ±cÄ± ID\'m: ', userId);
    
    // Pill'deki ID kÄ±smÄ±nÄ± gÃ¼ncelle
    const displayUserId = document.getElementById('displayUserId');
    if (displayUserId) {
      displayUserId.textContent = `ID: ${userId}`;
    }
    
    // Cihaz tipini server'a gÃ¶nder
    const currentUsername = document.getElementById('displayUsername')?.textContent || 'Misafir';
    socket.send(JSON.stringify({
      type: 'device_info',
      userId: userId,
      deviceType: deviceType,
      userName: currentUsername
    }));
  }

  // KullanÄ±cÄ± listesi gÃ¼ncellendiÄŸinde
  if (message.type === 'user_list') {
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('ğŸ“‹ KullanÄ±cÄ± listesi gÃ¼ncellendi:');
    message.users.forEach(u => {
      const isSelf = u.id === userId ? ' (BEN)' : '';
      console.log(`   ğŸ‘¤ ${u.username} ${u.deviceType}${isSelf}`);
    });
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    
    const userListElement = document.getElementById('userList');
    const onlineCountElement = document.getElementById('onlineCount');
    userListElement.innerHTML = '';
    
    // Ã‡evrimiÃ§i kullanÄ±cÄ± sayÄ±sÄ±nÄ± gÃ¼ncelle
    const otherUsersCount = message.users.filter(u => u.id !== userId).length;
    onlineCountElement.textContent = otherUsersCount;
    
    message.users.forEach(userInfo => {
      const li = document.createElement('li');
      li.className = "list-group-item d-flex justify-content-between align-items-center";
      const deviceIcon = userInfo.deviceType || 'ğŸ’»';
      const displayName = userInfo.username || userInfo.id;
      
      if (userInfo.id === userId) {
        li.innerHTML = `
          <span><strong>${displayName}</strong> ${deviceIcon}</span>
          <span class="badge bg-success">Ben</span>
        `;
      } else {
        li.innerHTML = `
          <span>${displayName} ${deviceIcon}</span>
          <button class="btn btn-sm btn-outline-primary">
            <i class="bi bi-telephone"></i> Ara
          </button>
        `;
        li.style.cursor = 'pointer';
        li.style.transition = 'background-color 0.2s';
        
        // Hover efekti
        li.addEventListener('mouseenter', () => {
          li.style.backgroundColor = '#e3f2fd';
        });
        li.addEventListener('mouseleave', () => {
          li.style.backgroundColor = '';
        });
        
        // TÄ±klama ile baÄŸlantÄ± isteÄŸi
        li.addEventListener('click', () => {
          const confirmConnect = confirm(`${displayName} ${deviceIcon} ile baÄŸlantÄ± kurmak istiyor musunuz?`);
          if (confirmConnect) {
            socket.send(JSON.stringify({
              type: 'connect_request',
              targetUserId: userInfo.id
            }));
            console.log(`ğŸ“ BaÄŸlantÄ± isteÄŸi gÃ¶nderildi: ${userInfo.id}`);
            alert(`BaÄŸlantÄ± isteÄŸi ${displayName} kullanÄ±cÄ±sÄ±na gÃ¶nderildi.`);
          }
        });
      }
      userListElement.appendChild(li);
    });
  }

  // BaÄŸlantÄ± isteÄŸi geldiÄŸinde (KarÅŸÄ± taraftan)
  if (message.type === 'connect_request') {
    const displayName = message.fromUsername || message.fromUserId;
    console.log(`ğŸ“ BaÄŸlantÄ± isteÄŸi alÄ±ndÄ±: ${displayName}`);
    
    const modal = document.getElementById('connectionModal');
    const requestText = document.getElementById('connectionRequestText');
    requestText.textContent = `${displayName} sizinle baÄŸlantÄ± kurmak istiyor. Kabul ediyor musunuz?`;
    modal.style.display = 'block';
    
    document.getElementById('acceptConnectionBtn').onclick = () => {
      modal.style.display = 'none';
      socket.send(JSON.stringify({
        type: 'connect_response',
        fromUserId: message.fromUserId,
        accepted: true
      }));
      console.log(`âœ… BaÄŸlantÄ± isteÄŸi kabul edildi: ${message.fromUserId}`);
    };
    
    document.getElementById('rejectConnectionBtn').onclick = () => {
      modal.style.display = 'none';
      socket.send(JSON.stringify({
        type: 'connect_response',
        fromUserId: message.fromUserId,
        accepted: false
      }));
      console.log(`âŒ BaÄŸlantÄ± isteÄŸi reddedildi: ${message.fromUserId}`);
    };
  }

  // BaÄŸlantÄ± onaylandÄ±ÄŸÄ±nda
  if (message.type === 'connect_confirmed') {
    const displayName = message.targetUsername || message.targetUserId;
    console.log(`âœ… BaÄŸlantÄ± kuruldu: ${displayName}`);
    alert(`âœ… ${displayName} ile baÄŸlantÄ± baÅŸarÄ±yla kuruldu!\n\nArtÄ±k "KonuÅŸmaya BaÅŸla" butonuna basarak konuÅŸabilirsiniz.`);
    document.getElementById('targetUserId').value = message.targetUserId;
    
    // BaÄŸlantÄ± kurulunca butonlarÄ± deÄŸiÅŸtir
    document.getElementById('connectBtn').style.display = 'none';
    document.getElementById('disconnectBtn').style.display = 'block';
  }

  // BaÄŸlantÄ± reddedildiÄŸinde
  if (message.type === 'connect_rejected') {
    const displayName = message.targetUsername || message.targetUserId;
    console.log(`âŒ BaÄŸlantÄ± reddedildi: ${displayName}`);
    alert(`âŒ ${displayName} baÄŸlantÄ± isteÄŸinizi reddetti.`);
  }

  // BaÄŸlantÄ± kesildiÄŸinde
  if (message.type === 'disconnected') {
    const displayName = message.fromUsername || message.fromUserId;
    console.log(`ğŸ”Œ BaÄŸlantÄ± kesildi: ${displayName}`);
    alert(`ğŸ”Œ ${displayName} baÄŸlantÄ±yÄ± kesti.`);
    
    // ButonlarÄ± sÄ±fÄ±rla
    document.getElementById('connectBtn').style.display = 'block';
    document.getElementById('disconnectBtn').style.display = 'none';
    document.getElementById('targetUserId').value = '';
  }

  // Hata mesajÄ±
  if (message.type === 'error') {
    console.error(`âŒ Hata: ${message.message}`);
    alert(`âŒ Hata: ${message.message}`);
  }

  // Ses verisi alÄ±ndÄ±ÄŸÄ±nda
  if (message.type === 'audio') {
    const audioData = message.audioData;
    const audioBuffer = Uint8Array.from(atob(audioData), c => c.charCodeAt(0));
    const audioBlob = new Blob([audioBuffer], { type: 'audio/mp3' });
    const audioUrl = URL.createObjectURL(audioBlob);
    
    const newAudioElement = document.createElement('audio');
    newAudioElement.src = audioUrl;
    newAudioElement.controls = true;
    newAudioElement.classList.add("w-100", "mb-2");
    document.getElementById('incomingAudioContainer').appendChild(newAudioElement);
    
    audioQueue.push(audioUrl);
    playNextAudio();
  }

  // KarÅŸÄ± taraftan ses temizleme komutu alÄ±ndÄ±ÄŸÄ±nda
  if (message.type === 'clear_voice_received') {
    console.log('ğŸ§¹ KarÅŸÄ± taraftan temizleme komutu alÄ±ndÄ±');
    
    // Gelen sesli mesajlarÄ± temizle
    const incomingAudioContainer = document.getElementById('incomingAudioContainer');
    if (incomingAudioContainer) {
      incomingAudioContainer.innerHTML = '';
      console.log('âœ… Gelen sesli mesajlar temizlendi (karÅŸÄ± taraftan gelen komut)');
    }
    
    // Ses kuyruÄŸunu temizle
    audioQueue = [];
    isPlayingAudio = false;
    
    console.log('âœ… Ses kuyruÄŸu temizlendi');
  }
};

// KULLANICI ADI GÃœNCELLE butonu
document.getElementById('updateUsernameBtn').addEventListener('click', () => {
  const usernameInput = document.getElementById('usernameInput');
  const username = usernameInput.value.trim();
  
  if (!username) {
    alert('LÃ¼tfen bir kullanÄ±cÄ± adÄ± girin');
    return;
  }
  
  if (!userId) {
    alert('WebSocket baÄŸlantÄ±sÄ± bekleniyor...');
    return;
  }
  
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log('ğŸ“¤ KullanÄ±cÄ± adÄ± gÃ¼ncelleniyor:');
  console.log(`   Eski: ${document.getElementById('displayUsername')?.textContent || 'Misafir'}`);
  console.log(`   Yeni: ${username}`);
  console.log(`   User ID: ${userId}`);
  
  socket.send(JSON.stringify({
    type: 'update_username',
    userId: userId,
    username: username
  }));
  
  console.log('âœ… Server\'a gÃ¼ncelleme isteÄŸi gÃ¶nderildi');
  console.log('â³ Server tÃ¼m kullanÄ±cÄ±lara bildirecek...');
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  
  // Ãœstteki pill'i gÃ¼ncelle
  const displayUsername = document.getElementById('displayUsername');
  if (displayUsername) {
    displayUsername.textContent = username;
    console.log('âœ… Ãœst pill gÃ¼ncellendi:', username);
  }
  
  console.log('â³ KullanÄ±cÄ± listesi server tarafÄ±ndan gÃ¼ncellenecek...');
  alert(`âœ… KullanÄ±cÄ± adÄ±nÄ±z "${username}" olarak gÃ¼ncellendi!`);
});

// Enter tuÅŸu ile de gÃ¼ncelleme yapÄ±labilir
document.getElementById('usernameInput').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    document.getElementById('updateUsernameBtn').click();
  }
});

// BAÄLANTI KUR butonu
document.getElementById('connectBtn').addEventListener('click', () => {
  const targetUserId = document.getElementById('targetUserId').value;
  
  if (!targetUserId) {
    alert('LÃ¼tfen hedef kullanÄ±cÄ± ID\'sini girin');
    return;
  }

  socket.send(JSON.stringify({
    type: 'connect_request',
    targetUserId: targetUserId
  }));
  console.log('BaÄŸlantÄ± isteÄŸi gÃ¶nderildi:', targetUserId);
  alert('BaÄŸlantÄ± isteÄŸi gÃ¶nderildi!');
});

// BAÄLANTIYI KES butonu
document.getElementById('disconnectBtn').addEventListener('click', () => {
  const targetUserId = document.getElementById('targetUserId').value;
  
  if (!targetUserId) {
    console.warn('Hedef kullanÄ±cÄ± ID\'si bulunamadÄ±');
    return;
  }

  const confirmDisconnect = confirm('BaÄŸlantÄ±yÄ± kesmek istediÄŸinizden emin misiniz?');
  if (!confirmDisconnect) return;

  socket.send(JSON.stringify({
    type: 'disconnect',
    targetUserId: targetUserId
  }));
  
  console.log('ğŸ”Œ BaÄŸlantÄ± kesme isteÄŸi gÃ¶nderildi:', targetUserId);
  
  // ButonlarÄ± sÄ±fÄ±rla
  document.getElementById('connectBtn').style.display = 'block';
  document.getElementById('disconnectBtn').style.display = 'none';
  document.getElementById('targetUserId').value = '';
  
  alert('BaÄŸlantÄ± kesildi!');
});

</script>
  <script type="module" src="/src/js/main.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/wav-encoder@1.0.0/dist/wav-encoder.min.js"></script>
</body>
</html>